@page
@model PCM_357.Pages.Matches.MyMatchesModel
@{ ViewData["Title"] = "Lịch sử Thi đấu"; }

<div class="container-fluid px-lg-5">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["DebugInfo"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>@TempData["DebugInfo"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="font-bold text-dark">
            <i class="bi bi-clock-history text-primary me-2"></i>Lịch sử Thi đấu
        </h1>
        @if (User.IsInRole("Admin") || User.IsInRole("Referee"))
        {
            <a asp-page="/Matches/Create" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Ghi Kết Quả
            </a>
        }
    </div>

    @if (!Model.Matches.Any())
    {
        <div class="premium-card p-5 text-center">
            <div class="empty-state">
                <i class="bi bi-trophy empty-state-icon"></i>
                <div class="empty-state-title">Chưa có trận đấu nào</div>
                <p class="empty-state-text">Bạn chưa tham gia trận đấu nào. Hãy tham gia sàn đấu để bắt đầu!</p>
                <a asp-page="/Challenges/Index" class="btn btn-primary mt-3">
                    <i class="bi bi-trophy me-2"></i>Xem Sàn Đấu
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var match in Model.Matches)
            {
                // Determine if current user is in Team1 or Team2
                var isInTeam1 = match.Team1_Player1Id == Model.CurrentMemberId || match.Team1_Player2Id == Model.CurrentMemberId;
                var isWinner = (isInTeam1 && match.WinningSide == PCM_357.Entities.WinningSide.Team1) ||
                               (!isInTeam1 && match.WinningSide == PCM_357.Entities.WinningSide.Team2);
                var resultText = match.WinningSide == PCM_357.Entities.WinningSide.None ? "Chưa xác định" : (isWinner ? "Thắng" : "Thua");
                var resultClass = match.WinningSide == PCM_357.Entities.WinningSide.None ? "text-muted" : (isWinner ? "text-success" : "text-danger");
                var resultIcon = match.WinningSide == PCM_357.Entities.WinningSide.None ? "bi-question-circle" : (isWinner ? "bi-trophy-fill" : "bi-x-circle-fill");

                // Get opponent names
                var opponentNames = new List<string>();
                if (isInTeam1)
                {
                    if (match.Team2_Player1 != null) opponentNames.Add(match.Team2_Player1.FullName);
                    if (match.Team2_Player2 != null) opponentNames.Add(match.Team2_Player2.FullName);
                }
                else
                {
                    if (match.Team1_Player1 != null) opponentNames.Add(match.Team1_Player1.FullName);
                    if (match.Team1_Player2 != null) opponentNames.Add(match.Team1_Player2.FullName);
                }
                var opponentText = string.Join(" & ", opponentNames);

                <div class="col-md-6 col-lg-4">
                    <div class="premium-card p-4 h-100">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <small class="text-muted text-xs">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    @match.Date.ToString("dd/MM/yyyy HH:mm")
                                </small>
                            </div>
                            <span class="badge @(match.IsRanked ? "badge-primary" : "badge-secondary")">
                                @(match.IsRanked ? "Ranked" : "Friendly")
                            </span>
                        </div>

                        <div class="mb-3">
                            <div class="text-sm text-muted mb-1">Thể thức</div>
                            <div class="font-semibold">
                                <i class="bi bi-people me-1"></i>
                                @(match.MatchFormat == PCM_357.Entities.MatchFormat.Singles ? "Đơn" : "Đôi")
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="text-sm text-muted mb-1">Đối thủ</div>
                            <div class="font-semibold">@opponentText</div>
                        </div>

                        <div class="pt-3 border-top">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="text-sm text-muted">Kết quả</span>
                                <span class="@resultClass font-bold">
                                    <i class="bi @resultIcon me-1"></i>
                                    @resultText
                                </span>
                            </div>
                        </div>

                        @if (match.Challenge != null)
                        {
                            <div class="mt-3 pt-3 border-top">
                                <small class="text-muted">
                                    <i class="bi bi-trophy me-1"></i>
                                    @match.Challenge.Title
                                </small>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>
